<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
<body style="background-color: #d8d8d8;">
<h1><p align="center">MTB Part Picker</p></h1>
<table style="width:100%">
  <tr bgcolor="#626262">
    <th>Component</th>
    <th>Selection</th>
    <th>Compatibility</th>
    <th>Price</th>
  </tr>
  <tr bgcolor="bfbfbf">
    <td><a href="Frame.html">Frame</a></td>
    <td>
      <p id="frame_name" style="display:inline-table"></p>
      <button id="removeFrame_button" onclick="remove('frame')">remove</button>
    </td>
    <td></td>
    <td><p id="frame_price"></p></td>
  </tr>
  <tr bgcolor="d8d6d6">
    <td><a href="Drivetrain.html">Drivetrain</a></td>
    <td>
      <p id="drivetrain_name" style="display:inline-table"></p>
      <button id="removeDrivetrain_button" onclick="remove('drivetrain')">remove</button>
    </td>
    <td></td>
    <td><p id="drivetrain_price"></p></td>
  </tr>
  <tr bgcolor="bfbfbf">
    <td><a href="Fork.html">Fork</a></td>
    <td>
      <p id="fork_name" style="display:inline-table"></p>
      <button id="removeFork_button" onclick="remove('fork')">remove</button>
    </td>
    <td></td>
    <td><p id="fork_price"></p></td>
  </tr>
  <tr bgcolor="d8d6d6">
    <td><a href="Shock.html">Shock</a></td>
    <td>
      <p id="shock_name" style="display:inline-table"></p>
      <button id="removeShock_button" onclick="remove('shock')">remove</button>
    </td>
    <td></td>
    <td><p id="shock_price"></p></td>
  </tr>
  <tr bgcolor="#939393">
    <td><b>Total</b></td>
    <td></td>
    <td></td>
    <td><p id="total"></p></td>
  </tr>
</table>

<!-- <script type="text/javascript" src="compatibility.js"></script> -->

<script>
//TODO Add compatibility system
//TODO Convert cookie format to JSON Object retrival
//TODO Add more kinds of parts (wheels, brakes, etc.)
//TODO Add photos for each kind of part
//TODO Fix colour scheme and do more front-end stuff

//run main function when page loads
window.onload = intro();
function intro(){
  //hide remove-part buttons
  hide_buttons();

  //If a frame is selected, show its info on the table
  isFrame(function(b){//callback from isFrame
    if(b){
      //Getting details from server
      getFrameInfo();
      //show "remove frame" button
      document.getElementById("removeFrame_button").style.display = 'block';
    }
  }).then(isFork(function(b){//Check if fork is selected
    console.log("checking for fork");
    if(b){
      console.log("fork selected");
      getForkInfo();
      //show remove fork button
      document.getElementById("removeFork_button").style.display = 'block';
    }
  }).then(main()));
}
function main(){
  //declaring some variables
  var framePrice=0;
  var drivetrainPrice=0;
  var forkPrice=0;
  var shockPrice=0;
}

//Check if frame is selected
async function isFrame(callback){
  var isframeRequest = new XMLHttpRequest();
  let framePromise = new Promise((resolve, reject) => {
    isframeRequest.onreadystatechange = function check(){
      //console.log("isframeRequest status = " + isframeRequest.status);
      if(isframeRequest.readyState == 4 && isframeRequest.status == 200){
        if(isframeRequest.responseText != ""){
          //Frame is selected
          console.log(isframeRequest.responseText);
          resolve(true);
        }
        else{
          //Frame not selected
          console.log("no frame selected");
          resolve(false);
        }
      }
    };
  });
  isframeRequest.open("GET", "isPart.php?pt=frame", true);
  isframeRequest.send();
  let b = await framePromise;
  console.log(b);
  callback(b);
}

//Check if fork is selected
async function isFork(callback){
  var isforkRequest = new XMLHttpRequest();
  let forkPromise = new Promise((resolve, reject) => {
    isforkRequest.onreadystatechange = function check(){
      //console.log("isforkRequest status = " + isforkRequest.status);
      if(isforkRequest.readyState == 4 && isforkRequest.status == 200){
        if(isforkRequest.responseText != ""){
          //Fork is selected
          console.log(isforkRequest.responseText);
          resolve(true);
        }
        else{
          //Fork not selected
          console.log("no fork selected");
          resolve(false);
        }
      }
    };
  });
  isforkRequest.open("GET", "isPart.php?pt=fork", true);
  isforkRequest.send();
  let b = await forkPromise;
  console.log(b);
  callback(b);
}

//remove item from list
function remove(Item){
  var removeRequest = new XMLHttpRequest();
  removeRequest.onreadystatechange = function(){
    console.log("remove: readyState = "+removeRequest.readyState+", status = "+removeRequest.status);
    if(removeRequest.readyState == 4 && removeRequest.status == 200){
      console.log("running remove");
      console.log(removeRequest.responseText);
      location.reload(true);
    }
  };
  removeRequest.open("GET", "remove.php?pt="+Item, true);
  removeRequest.send();

}

//show/hide button functions
function show_buttons(){
  document.getElementById("removeFrame_button").style.display = 'block';
  document.getElementById("removeDrivetrain_button").style.display = 'block';
  document.getElementById("removeFork_button").style.display = 'block';
  document.getElementById("removeShock_button").style.display = 'block';
}
function hide_buttons(){
  document.getElementById("removeFrame_button").style.display = 'none';
  document.getElementById("removeDrivetrain_button").style.display = 'none';
  document.getElementById("removeFork_button").style.display = 'none';
  document.getElementById("removeShock_button").style.display = 'none';
}

//async function for getting frame info and updating it in the main table
async function getFrameInfo(){
  //console.log("getting frame info");
  getInfoRequest("getName.php?pt=frame").then(function(response){
    frame_name = response;
    document.getElementById("frame_name").innerHTML = frame_name;
  });
  getInfoRequest("getPrice.php?pt=frame").then(function(response){
    //console.log(response);
    framePrice = response;
    document.getElementById("frame_price").innerHTML = "$"+framePrice;
    //Update total price
    document.getElementById("total").innerHTML = "$"+String(Number(framePrice) + Number(forkPrice));
  });
}

async function getForkInfo(){
  console.log("get fork info called");
  getInfoRequest("getName.php?pt=fork").then(function(response){
    fork_name = response;
    document.getElementById("fork_name").innerHTML = fork_name;
  });
  getInfoRequest("getPrice.php?pt=fork").then(function(response){
    forkPrice = response;
    document.getElementById("fork_price").innerHTML = "$"+forkPrice;
    //Update total price
    document.getElementById("total").innerHTML = "$"+String(Number(framePrice) + Number(forkPrice));
  });
}

//Get info request new attempt
function getInfoRequest(url){
  console.log("info request created for "+url);
  return new Promise(function(resolve){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onload = function(){
      if(this.status == 200){
        console.log("request successful");
        resolve(xhr.response);
      }
    };
    xhr.send();
  });
}

</script>

</body>
</html>
